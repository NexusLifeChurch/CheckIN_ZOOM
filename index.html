// --- ตั้งค่า ID ของ Google Sheet และชื่อ Sheet ---
const SPREADSHEET_ID = '1vg66sWHwsYWZf0zgso_E_WKx-ute4VCs4HxvcBMX5uI'; // ID จากลิงก์ที่คุณให้มา
const SHEET_CHECKIN = 'CheckIN';
const SHEET_LINEID = 'LineID';

// ลิงก์ ZOOM และ LIFF ลงทะเบียน
const ZOOM_LINK = 'https://us05web.zoom.us/j/83550129208?pwd=9zedCWiXUGW8GaX4zHQSYO8qxaFLRb.1';
const REGIS_LIFF_URL = 'https://liff.line.me/2008560135-QlLx9W3c';

function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('CheckIN ZOOM System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/**
 * ฟังก์ชันหลัก: ตรวจสอบสถานะ User และดำเนินการ Check-in
 */
function handleCheckInProcess(liffProfile) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheetLineId = ss.getSheetByName(SHEET_LINEID);
  
  // 1. ค้นหา UserID ใน Sheet LineID
  const dataLineId = sheetLineId.getDataRange().getValues();
  // สมมติว่า Line UserID อยู่คอลัมน์ B (Index 1) เริ่มค้นหาจาก row 2
  let foundRow = -1;
  let userData = null;

  for (let i = 1; i < dataLineId.length; i++) {
    if (dataLineId[i][1] == liffProfile.userId) {
      foundRow = i;
      userData = dataLineId[i];
      break;
    }
  }

  // กรณี: เจอข้อมูล (ลงทะเบียนแล้ว)
  if (foundRow !== -1) {
    recordToCheckIn(userData, liffProfile.userId);
    return { status: 'success', zoomUrl: ZOOM_LINK, message: 'เช็คชื่อสำเร็จ กำลังนำท่านเข้าสู่ ZOOM' };
  } 
  
  // กรณี: ไม่เจอข้อมูล (ยังไม่ลงทะเบียน)
  else {
    return { status: 'not_found', regisUrl: REGIS_LIFF_URL };
  }
}

/**
 * ฟังก์ชัน: กรณีไม่ประสงค์ลงทะเบียน (No Draw)
 * บันทึกลง Sheet LineID แบบข้อมูลเท่าที่มี แล้ว Check-in เลย
 */
function handleNoDrawRegistration(liffProfile) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheetLineId = ss.getSheetByName(SHEET_LINEID);

  const timestamp = new Date();
  const nickname = "(ไม่ประสงค์จับฉลาก)";
  const realname = ""; // ไม่มีข้อมูล
  const careGroup = "";
  const referrer = "";
  const phone = "";

  // เรียงข้อมูลตามคอลัมน์ Sheet LineID:
  // Timestamp | UserID | DisplayName | Picture | StatusMsg | ชื่อเล่น | ชื่อจริง | กลุ่มแคร์ | ผู้แนะนำ | เบอร์โทร
  const newRow = [
    timestamp,
    liffProfile.userId,
    liffProfile.displayName,
    liffProfile.pictureUrl,
    liffProfile.statusMessage,
    nickname,
    realname,
    careGroup,
    referrer,
    phone
  ];

  sheetLineId.appendRow(newRow);

  // หลังจากบันทึกแล้ว ให้ทำการ CheckIN ต่อทันที
  // เราส่ง newRow ไปเพื่อให้ฟังก์ชัน recordToCheckIn ใช้งานได้เลย
  recordToCheckIn(newRow, liffProfile.userId);

  return { status: 'success', zoomUrl: ZOOM_LINK, message: 'บันทึกข้อมูลสำเร็จ กำลังนำท่านเข้าสู่ ZOOM' };
}

/**
 * ฟังก์ชันช่วย: บันทึกลง Sheet CheckIN
 * dataLineIdRow คือ array ข้อมูลของ user คนนั้นจาก Sheet LineID
 */
function recordToCheckIn(dataLineIdRow, userId) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheetCheckIn = ss.getSheetByName(SHEET_CHECKIN);

  // Map ข้อมูลจาก Sheet LineID (Array Index)
  // Index: 0=Time, 1=UserID, 2=Display, 3=Pic, 4=Status, 5=Nick, 6=Real, 7=Care, 8=Referrer, 9=Phone
  
  const timestamp = new Date();
  const actName = "Caremily";
  const category = "Care";
  const zoomName = "Luv Christmas";
  
  // Details ="LineID.Display Name"+"LineID.ผู้แนะนำ"+"LineID.เบอร์โทร"
  const displayName = dataLineIdRow[2] || "";
  const referrer = dataLineIdRow[8] || "";
  const phone = dataLineIdRow[9] || "";
  const details = `${displayName} ${referrer} ${phone}`.trim();

  // M_ID ="LineID.ชื่อเล่น"+”-”+"LindID.ชื่อจริง"
  const nickName = dataLineIdRow[5] || "";
  const realName = dataLineIdRow[6] || "";
  const mId = `${nickName}-${realName}`;

  const careName = dataLineIdRow[7] || ""; // กลุ่มแคร์
  const memberStatus = "";

  // เรียงข้อมูลตามคอลัมน์ Sheet CheckIN
  // Timestamp | LINE ID | Act_Name | Category | ZOOM_name | Details | M_ID | Name | CareName | MemberStatus
  const checkInRow = [
    timestamp,
    userId,
    actName,
    category,
    zoomName,
    details,
    mId,
    displayName, // Name
    careName,
    memberStatus
  ];

  sheetCheckIn.appendRow(checkInRow);
}
