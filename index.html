<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NxLife Community - Check-in</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Config for Tailwind colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Prompt', 'sans-serif'],
                    },
                    colors: {
                        coffee: {
                            50: '#fdf8f6',
                            100: '#f2e8e5',
                            200: '#eaddd7',
                            300: '#e0c1b3',
                            400: '#d2a592',
                            500: '#b87c6d', // Accent
                            600: '#8c594d',
                            700: '#6f4e37', // Main Coffee
                            800: '#4b3832', // Dark Roast
                            900: '#2d211e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles for Interactions and Aesthetics */
        body {
            background-color: #f7f3f0; /* Creamy background */
            background-image: radial-gradient(#eaddd7 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px -5px rgba(111, 78, 55, 0.15), 0 8px 10px -6px rgba(111, 78, 55, 0.1);
        }

        .coffee-gradient-text {
            background: linear-gradient(135deg, #6f4e37, #b87c6d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-coffee {
            background: linear-gradient(135deg, #6f4e37, #8c594d);
            transition: all 0.3s ease;
        }

        .btn-coffee:hover {
            background: linear-gradient(135deg, #8c594d, #6f4e37);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
        }

        .btn-coffee:active {
            transform: translateY(0);
        }
        
        .btn-outline-coffee {
            background: transparent;
            border: 2px solid #6f4e37;
            color: #6f4e37;
            transition: all 0.3s ease;
        }
        
        .btn-outline-coffee:hover {
            background: #6f4e37;
            color: white;
            transform: translateY(-2px);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #eaddd7;
            border-top: 4px solid #6f4e37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Input Focus Transition */
        .input-transition {
            transition: all 0.2s ease-in-out;
        }
        .input-transition:focus {
            border-color: #6f4e37;
            box-shadow: 0 0 0 3px rgba(111, 78, 55, 0.1);
        }

        /* Pulse Animation for Button */
        .pulse-btn {
            animation: pulse-coffee 2s infinite;
        }
        @keyframes pulse-coffee {
            0% { box-shadow: 0 0 0 0 rgba(111, 78, 55, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(111, 78, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(111, 78, 55, 0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-coffee-800">

    <!-- Main Card Container -->
    <div class="glass-card w-full max-w-md rounded-3xl overflow-hidden relative">
        
        <!-- Header / Decorative Top -->
        <div class="h-2 bg-gradient-to-r from-coffee-700 via-coffee-500 to-coffee-300"></div>

        <div class="p-8 pt-10 text-center">
            
            <!-- Logo / Brand Area -->
            <div class="mb-6 animate-fade-in-down">
                <div class="w-20 h-20 mx-auto bg-coffee-100 rounded-full flex items-center justify-center mb-3 shadow-inner">
                    <i class="fa-solid fa-mug-hot text-3xl text-coffee-700"></i>
                </div>
                <h1 class="text-2xl font-bold coffee-gradient-text tracking-tight">NxLife Community</h1>
                <p class="text-sm text-coffee-400 mt-1">ZOOM Check-in System</p>
            </div>

            <!-- Dynamic Content Area -->
            <div id="app-content" class="min-h-[200px] flex flex-col items-center justify-center">
                
                <!-- STATE 1: LOADING -->
                <div id="loading-state" class="flex flex-col items-center gap-4">
                    <div class="spinner"></div>
                    <p id="loading-text" class="text-coffee-600 font-medium animate-pulse">กำลังเชื่อมต่อ LINE...</p>
                </div>

                <!-- STATE 2: REGISTRATION FORM (Hidden by default) -->
                <div id="register-state" class="hidden w-full text-left animate-fade-in-up">
                    <div class="flex items-center gap-3 mb-6 bg-coffee-50 p-3 rounded-xl border border-coffee-100">
                        <img id="user-picture" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover">
                        <div>
                            <p class="text-xs text-coffee-400">สวัสดีคุณ</p>
                            <p id="user-display-name" class="font-semibold text-coffee-800 line-clamp-1">User Name</p>
                        </div>
                    </div>

                    <form id="checkin-form" onsubmit="handleRegister(event)" class="space-y-4">
                        <div>
                            <label for="fullname" class="block text-sm font-medium text-coffee-700 mb-1">
                                กรุณาใส่ชื่อที่ต้องการใช้ในการจับรางวัล <span class="text-red-400">*</span>
                            </label>
                            <input type="text" id="fullname" required
                                class="w-full px-4 py-3 rounded-xl border border-coffee-200 bg-white text-coffee-800 focus:outline-none input-transition"
                                placeholder="เช่น สมชัย (ชัย) Alpha 7/3"
                                oninvalid="this.setCustomValidity('กรุณาใส่ชื่อของท่านก่อน')"
                                oninput="this.setCustomValidity('')">
                            <p class="text-xs text-coffee-400 mt-2 leading-relaxed">
                                <i class="fa-solid fa-circle-info mr-1"></i>
                                กรุณาใช้ <strong>"ชื่อจริง (ชื่อเล่น)"</strong> หรือชื่อที่ทีมงานจำได้ เพื่อลุ้นรับรางวัลและระบุตัวตนได้ถูกต้อง
                            </p>
                        </div>

                        <button type="submit" id="submit-btn" 
                            class="w-full btn-coffee text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 mt-6">
                            <span>ยืนยันและเข้า ZOOM</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </form>
                </div>

                <!-- STATE 3: SUCCESS / REDIRECT (Hidden by default) -->
                <div id="success-state" class="hidden flex flex-col items-center gap-4 text-center animate-fade-in-up w-full">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2">
                        <i class="fa-solid fa-check text-3xl"></i>
                    </div>
                    <h3 id="success-title" class="text-xl font-bold text-coffee-800">ลงทะเบียนสำเร็จ!</h3>
                    <p id="success-message" class="text-coffee-600 text-sm leading-relaxed px-4 mb-4">ระบบพร้อมแล้ว</p>
                    
                    <!-- Manual Button for iOS Stability + Auto Redirect (For ZOOM=Y) -->
                    <button onclick="launchZoom()" id="manual-zoom-btn" 
                        class="hidden pulse-btn w-full btn-coffee text-white font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 transform transition hover:scale-105">
                        <i class="fa-solid fa-video text-xl"></i>
                        <span class="text-lg">กดเพื่อเข้าห้อง ZOOM</span>
                    </button>
                    
                    <!-- Close Button (For ZOOM=N) -->
                    <button onclick="liff.closeWindow()" id="close-window-btn" 
                        class="hidden w-full btn-outline-coffee font-bold py-3 px-6 rounded-xl shadow-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-xmark text-lg"></i>
                        <span class="text-lg">ปิดหน้าต่าง</span>
                    </button>
                    
                    <p id="footer-msg" class="text-[12px] text-coffee-400 mt-4 font-semibold tracking-wide">Connect&Empower By Nexus Life</p>
                </div>

                <!-- STATE 4: ERROR (Hidden by default) -->
                <div id="error-state" class="hidden flex flex-col items-center gap-4 text-center">
                    <div class="w-14 h-14 bg-red-50 rounded-full flex items-center justify-center text-red-500 mb-2">
                        <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                    </div>
                    <p id="error-message" class="text-coffee-700 text-sm">เกิดข้อผิดพลาด</p>
                    <button onclick="location.reload()" class="text-xs text-coffee-500 underline mt-2">ลองใหม่อีกครั้ง</button>
                </div>

            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-coffee-50 px-8 py-4 text-center border-t border-coffee-100">
            <p class="text-[10px] text-coffee-300">© 2024 NxLife Community. All rights reserved. <span id="version-display" class="ml-1 text-coffee-200">v1.90</span></p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            LIFF_ID: "2008560135-RlOW0At4",
            GAS_ENDPOINT: "https://script.google.com/macros/s/AKfycbxTTOnhmwetGEtfePkAgDQMLsWuzk3uWVH67B5_HuVVOHhVxrQONTdVKGLnvlHhgkaVnQ/exec",
            ZOOM_URL: "https://us05web.zoom.us/j/83550129208?pwd=9zedCWiXUGW8GaX4zHQSYO8qxaFLRb.1"
        };

        // --- GLOBAL VARIABLES ---
        let userProfile = null;
        
        // Check URL Parameter for ZOOM=N
        const urlParams = new URLSearchParams(window.location.search);
        const shouldOpenZoom = urlParams.get('ZOOM') !== 'N'; // Default is True unless ZOOM=N explicitly

        // --- DOM ELEMENTS ---
        const dom = {
            loadingState: document.getElementById('loading-state'),
            loadingText: document.getElementById('loading-text'),
            registerState: document.getElementById('register-state'),
            successState: document.getElementById('success-state'),
            successTitle: document.getElementById('success-title'),
            successMessage: document.getElementById('success-message'),
            manualZoomBtn: document.getElementById('manual-zoom-btn'),
            closeWindowBtn: document.getElementById('close-window-btn'),
            footerMsg: document.getElementById('footer-msg'),
            errorState: document.getElementById('error-state'),
            errorMessage: document.getElementById('error-message'),
            form: document.getElementById('checkin-form'),
            userPic: document.getElementById('user-picture'),
            displayName: document.getElementById('user-display-name'),
            submitBtn: document.getElementById('submit-btn')
        };

        // --- INITIALIZATION ---
        async function main() {
            // Adjust Button Text based on Mode (ZOOM=N or Y)
            if (!shouldOpenZoom) {
                dom.submitBtn.innerHTML = `<span>กด ลงทะเบียน</span><i class="fa-solid fa-user-plus"></i>`;
            }

            try {
                // 1. Init LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 2. Get Profile
                dom.loadingText.innerText = "กำลังดึงข้อมูล Profile...";
                userProfile = await liff.getProfile();
                
                // Populate Profile UI
                dom.userPic.src = userProfile.pictureUrl || "https://ui-avatars.com/api/?name=" + userProfile.displayName;
                dom.displayName.innerText = userProfile.displayName;

                // 3. Check Registration with Backend
                dom.loadingText.innerText = "กำลังตรวจสอบสถานะ...";
                await checkUserStatus(userProfile.userId);

            } catch (err) {
                showError("ไม่สามารถเชื่อมต่อ LINE หรือ Server ได้: " + err.message);
            }
        }

        // --- BACKEND API CALLS ---
        
        async function checkUserStatus(userId) {
            try {
                const url = `${CONFIG.GAS_ENDPOINT}?action=check&userId=${userId}`;
                const response = await fetch(url, { method: 'GET', redirect: 'follow' });
                const text = await response.text();
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    if (text.includes("action=") || text.includes("userId=")) {
                         showError("Google Apps Script เวอร์ชันเก่า: กรุณา Deploy ใหม่");
                         return;
                    }
                    showRegisterForm();
                    return;
                }

                if (data.status === 'registered') {
                    // Already Registered
                    // ตรวจสอบชื่อที่ได้จาก Backend
                    if (shouldOpenZoom) {
                        // Show "Ready to Join" screen AND Try to Auto Launch
                        showReadyToJoin(data.registeredName, userProfile.displayName);
                        // Auto-launch attempt after 1.5 seconds
                        setTimeout(() => {
                            launchZoom();
                        }, 1500);
                    } else {
                        // ZOOM=N: Show custom message with Close button
                        showNoZoomMessage(data.registeredName, userProfile.displayName);
                    }
                } else {
                    // Not Registered -> Show Form
                    showRegisterForm();
                }
            } catch (error) {
                console.error("API Error", error);
                showRegisterForm(); 
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const fullname = document.getElementById('fullname').value;
            setLoadingButton(true);

            try {
                const params = new URLSearchParams();
                params.append('action', 'register');
                params.append('userId', userProfile.userId);
                params.append('displayName', userProfile.displayName);
                params.append('pictureUrl', userProfile.pictureUrl);
                params.append('statusMessage', userProfile.statusMessage);
                params.append('name', fullname); 
                
                const url = `${CONFIG.GAS_ENDPOINT}?${params.toString()}`;
                const response = await fetch(url, { method: 'GET', redirect: 'follow' });
                const text = await response.text();
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (jsonError) {
                    throw new Error("Invalid Server Response");
                }

                if (data.status === 'success') {
                    if (shouldOpenZoom) {
                        // Show "Ready to Join" screen AND Try to Auto Launch
                        showReadyToJoin(fullname, userProfile.displayName);
                        setTimeout(() => {
                            launchZoom();
                        }, 1500);
                    } else {
                        // ZOOM=N
                        showNoZoomMessage(fullname, userProfile.displayName);
                    }
                } else {
                    throw new Error(data.message || "Status: " + data.status);
                }

            } catch (error) {
                alert("เกิดข้อผิดพลาด: " + error.message);
                setLoadingButton(false);
            }
        }

        // --- UI STATES ---

        function showRegisterForm() {
            dom.loadingState.classList.add('hidden');
            dom.registerState.classList.remove('hidden');
        }

        // New State: Show button to join (Fixes iOS auto-redirect block)
        function showReadyToJoin(regName, lineName) {
            dom.loadingState.classList.add('hidden');
            dom.registerState.classList.add('hidden');
            dom.successState.classList.remove('hidden');
            
            // ZOOM=Y: Show Zoom Button, Hide Close Button
            dom.manualZoomBtn.classList.remove('hidden'); 
            dom.closeWindowBtn.classList.add('hidden');

            dom.successTitle.innerText = "ลงทะเบียนเรียบร้อยแล้ว";
            
            // Format: Name (Display Name)
            const displayNameText = regName ? `${regName} (${lineName})` : lineName;
            
            dom.successMessage.innerHTML = `สวัสดีคุณ <strong>${displayNameText}</strong><br>ระบบกำลังเปิดห้อง ZOOM อัตโนมัติ...`;
        }

        // ZOOM=N State
        function showNoZoomMessage(regName, lineName) {
            dom.loadingState.classList.add('hidden');
            dom.registerState.classList.add('hidden');
            dom.successState.classList.remove('hidden');
            
            // ZOOM=N: Hide Zoom Button, Show Close Button
            dom.manualZoomBtn.classList.add('hidden'); 
            dom.closeWindowBtn.classList.remove('hidden');
            
            dom.successTitle.innerText = "ลงทะเบียนเรียบร้อยแล้ว";
            
            // Format: Name (Display Name)
            const displayNameText = regName ? `${regName} (${lineName})` : lineName;

            dom.successMessage.innerHTML = `คุณได้ลงทะเบียนในระบบแล้ว ในชื่อ<br><strong class="text-lg text-coffee-700">${displayNameText}</strong><br><br>ไม่จำเป็นต้องลงทะเบียนซ้ำ<br>แล้วพบกันใน ZOOM นะคะ<br>วันศุกร์นี้ ห้องเปิด 1 ทุ่ม 10 นาที`;
        }

        // --- ZOOM LAUNCHER WITH DELAYED CLOSE ---
        function launchZoom() {
            // 1. Trigger Open Zoom
            if (liff.isInClient()) {
                liff.openWindow({
                    url: CONFIG.ZOOM_URL,
                    external: true
                });
            } else {
                window.location.href = CONFIG.ZOOM_URL;
            }

            // 2. Schedule Close Window (5 seconds delay)
            if (liff.isInClient()) {
                setTimeout(() => {
                    liff.closeWindow();
                }, 5000); // 5000ms = 5 seconds
            }
        }

        function showError(msg) {
            dom.loadingState.classList.add('hidden');
            dom.registerState.classList.add('hidden');
            dom.errorState.classList.remove('hidden');
            dom.errorMessage.innerText = msg;
        }

        function setLoadingButton(isLoading) {
            if (isLoading) {
                dom.submitBtn.innerHTML = `<div class="spinner border-white border-t-transparent w-5 h-5 mr-2"></div> กำลังบันทึก...`;
                dom.submitBtn.disabled = true;
                dom.submitBtn.classList.add('opacity-75');
            } else {
                // Restore text based on mode
                if (shouldOpenZoom) {
                    dom.submitBtn.innerHTML = `<span>ยืนยันและเข้า ZOOM</span><i class="fa-solid fa-arrow-right"></i>`;
                } else {
                    dom.submitBtn.innerHTML = `<span>กด ลงทะเบียน</span><i class="fa-solid fa-user-plus"></i>`;
                }
                
                dom.submitBtn.disabled = false;
                dom.submitBtn.classList.remove('opacity-75');
            }
        }

        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
